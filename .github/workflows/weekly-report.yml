name: Weekly Karma Report

on:
  schedule:
    - cron: '0 12 * * 0'  # Every Sunday at noon UTC
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  weekly-report:
    runs-on: [self-hosted, enjoy-trusted]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let state;
            try {
              state = JSON.parse(fs.readFileSync('state.json', 'utf8'));
            } catch (e) {
              console.log('Could not load state.json');
              return;
            }
            
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            
            // Calculate weekly stats
            let weeklyKarma = {};
            let totalWeeklyKarma = 0;
            
            if (state.engagement && state.engagement.karma_log) {
              for (const entry of state.engagement.karma_log) {
                const entryDate = new Date(entry.timestamp);
                if (entryDate >= weekAgo) {
                  if (!weeklyKarma[entry.actor]) {
                    weeklyKarma[entry.actor] = 0;
                  }
                  weeklyKarma[entry.actor] += entry.karma;
                  totalWeeklyKarma += entry.karma;
                }
              }
            }
            
            // Sort by karma
            const sorted = Object.entries(weeklyKarma)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 10);
            
            // Generate report
            let report = `# ðŸ“Š Weekly Karma Report\n\n`;
            report += `**Week of ${weekAgo.toISOString().split('T')[0]} to ${now.toISOString().split('T')[0]}**\n\n`;
            report += `## ðŸ† Top Contributors\n\n`;
            report += `| Rank | Player | Karma |\n`;
            report += `|------|--------|-------|\n`;
            
            const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
            sorted.forEach((entry, i) => {
              const medal = medals[i] || `${i + 1}.`;
              report += `| ${medal} | @${entry[0]} | +${entry[1]} |\n`;
            });
            
            report += `\n## ðŸ“ˆ Statistics\n\n`;
            report += `- **Total Karma Earned:** ${totalWeeklyKarma}\n`;
            report += `- **Active Players:** ${Object.keys(weeklyKarma).length}\n`;
            report += `- **Average per Player:** ${Object.keys(weeklyKarma).length ? Math.round(totalWeeklyKarma / Object.keys(weeklyKarma).length) : 0}\n`;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ðŸ• TIME-BASED STATISTICS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (state.time_system && state.time_system.stats) {
              report += `\n## â° Time-Based Activity\n\n`;
              report += `| Period | PRs | Total Karma |\n`;
              report += `|--------|-----|-------------|\n`;
              
              const timeStats = state.time_system.stats;
              const periods = ['dawn', 'morning', 'noon', 'afternoon', 'sunset', 'night'];
              const emojis = { dawn: 'ðŸŒ…', morning: 'â˜€ï¸', noon: 'ðŸŒž', afternoon: 'ðŸŒ¤ï¸', sunset: 'ðŸŒ†', night: 'ðŸŒ™' };
              
              let mostActive = { period: '', karma: 0 };
              
              for (const period of periods) {
                if (timeStats[period]) {
                  const stats = timeStats[period];
                  report += `| ${emojis[period]} ${period.charAt(0).toUpperCase() + period.slice(1)} | ${stats.total_prs || 0} | ${stats.total_karma || 0} |\n`;
                  if ((stats.total_karma || 0) > mostActive.karma) {
                    mostActive = { period, karma: stats.total_karma };
                  }
                }
              }
              
              if (mostActive.period) {
                report += `\n**ðŸ† Most Active Period:** ${emojis[mostActive.period]} ${mostActive.period.charAt(0).toUpperCase() + mostActive.period.slice(1)} (${mostActive.karma} karma)\n`;
              }
              
              // Rare events
              if (state.time_system.rare_events_triggered && state.time_system.rare_events_triggered.length > 0) {
                report += `\n### ðŸŽ¯ Rare Time Events Triggered\n\n`;
                for (const event of state.time_system.rare_events_triggered.slice(-5)) {
                  report += `- ${event}\n`;
                }
              }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ðŸš« CLOSED/REFUSED PRs
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const { data: closedPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 50
            });
            
            const refusedPRs = closedPRs.filter(pr => {
              const closedAt = new Date(pr.closed_at);
              return !pr.merged_at && closedAt >= weekAgo;
            });
            
            if (refusedPRs.length > 0) {
              report += `\n## ðŸš« PRs Closed Without Merge\n\n`;
              report += `| PR | Author | Reason | Closed |\n`;
              report += `|----|--------|--------|--------|\n`;
              
              for (const pr of refusedPRs.slice(0, 10)) {
                const closedDate = new Date(pr.closed_at).toLocaleDateString();
                // Check if it was the author who closed it (abandoned) or someone else (refused)
                const reason = pr.user.login === pr.closed_by?.login ? 'ðŸƒ Abandoned' : 'âŒ Refused';
                report += `| [#${pr.number}](${pr.html_url}) | @${pr.user.login} | ${reason} | ${closedDate} |\n`;
              }
              
              report += `\n> ðŸ’¡ *PRs closed without merge don't count against you. Keep trying!*\n`;
            } else {
              report += `\n## âœ… No Refused PRs This Week\n\nAll submitted PRs were merged! Great work everyone! ðŸŽ‰\n`;
            }
            
            report += `\n---\n*Keep playing! Every action counts. [Check time bonuses](https://fabriziosalmi.github.io/enjoy/time.html)*\n`;
            
            console.log(report);
            
            // Save report
            const reportFile = `reports/weekly-${now.toISOString().split('T')[0]}.md`;
            fs.mkdirSync('reports', { recursive: true });
            fs.writeFileSync(reportFile, report);
            
            core.setOutput('report', report);
            core.setOutput('report_file', reportFile);
        id: report

      - name: Commit Report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Karma Bot"
          git add reports/
          git diff --staged --quiet || git commit -m "ðŸ“Š Weekly karma report [skip ci]"
          git push || echo "Nothing to push"
