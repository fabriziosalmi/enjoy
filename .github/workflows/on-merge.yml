name: Update State on Merge

on:
  pull_request:
    types: [closed]

concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

jobs:
  update-state:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure git
        run: |
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
      
      - name: Update state
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          node --input-type=module -e "
            import { readFileSync, writeFileSync } from 'fs';
            
            // Load state from root
            const state = JSON.parse(readFileSync('./state.json', 'utf8'));
            
            const author = process.env.PR_AUTHOR || 'unknown';
            const prNumber = parseInt(process.env.PR_NUMBER) || 0;
            const prTitle = process.env.PR_TITLE || '';
            
            // Simple karma: 10 base points per PR
            const karma = 10;
            
            // Update counters
            state.meta.total_prs++;
            if (!state.players[author]) {
              state.players[author] = {
                karma: 0,
                prs: 0,
                joined: new Date().toISOString()
              };
              state.meta.total_players++;
            }
            state.players[author].prs++;
            state.players[author].karma += karma;
            
            state.last_updated = new Date().toISOString();
            state.last_pr = '#' + prNumber;
            
            // Update score
            state.score.total += karma;
            
            // Check level progress
            if (state.levels.next_unlock) {
              state.levels.next_unlock.progress.score = state.score.total;
              state.levels.next_unlock.progress.prs = state.meta.total_prs;
              
              const next = state.levels.next_unlock;
              const needsScore = next.progress.score >= next.requires_score;
              const needsPrs = next.progress.prs >= next.requires_prs;
              
              if (needsScore || needsPrs) {
                console.log('ðŸŽ‰ LEVEL UP! Unlocking level', next.level_id);
                state.levels.current = next.level_id;
                state.levels.unlocked.push(next.level_id);
                
                if (next.level_id < 100) {
                  state.levels.next_unlock = {
                    level_id: next.level_id + 1,
                    requires_score: Math.floor(next.requires_score * 1.5),
                    requires_prs: next.requires_prs + 3,
                    progress: { score: state.score.total, prs: state.meta.total_prs }
                  };
                } else {
                  state.levels.next_unlock = null;
                  console.log('ðŸ† MAX LEVEL 100 REACHED!');
                }
              }
            }
            
            writeFileSync('./state.json', JSON.stringify(state, null, 2));
            console.log('âœ… State updated: Score=' + state.score.total + ', Level=' + state.levels.current + ', PRs=' + state.meta.total_prs);
          "
      
      - name: Commit and push
        run: |
          git add state.json
          git commit -m "ðŸ“Š State update from PR #${{ github.event.pull_request.number }}" || echo "No changes"
          git push
