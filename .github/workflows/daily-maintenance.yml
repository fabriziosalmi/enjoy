name: Daily Maintenance

on:
  schedule:
    - cron: '0 0 * * *'  # Every day at midnight UTC
  workflow_dispatch:  # Manual trigger

concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

jobs:
  maintenance:
    runs-on: [self-hosted, enjoy-trusted]
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Backup state.json
        run: |
          mkdir -p backups
          cp state.json "backups/state-$(date +%Y-%m-%d).json"
          # Keep only last 7 backups
          ls -t backups/state-*.json | tail -n +8 | xargs rm -f 2>/dev/null || true
          echo "âœ… State backed up"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: engine/package-lock.json

      - name: Install dependencies
        run: |
          cd engine
          npm ci
      
      - name: Build engine
        run: |
          cd engine
          npm run build
      
      - name: Run decay check
        run: |
          cd engine
          node -e "
            const { loadState, saveState } = require('./dist/loader.js');
            const { applyDecaySystem, getDecayStatus } = require('./dist/decay.js');
            
            const state = loadState();
            
            console.log('=== DAILY MAINTENANCE ===');
            console.log('Current level:', state.levels.current);
            console.log('Global karma:', state.karma.global);
            
            // Check decay status
            const status = getDecayStatus(state);
            console.log('Decay status:', status);
            
            // Apply decay if needed
            const result = applyDecaySystem(state);
            console.log('Decay result:', result.message);
            
            // Save state
            saveState(state);
            
            // Output for commit message
            if (result.karma_decay.decayed || result.level_decay.decayed) {
              console.log('DECAY_APPLIED=true');
            }
          "
      
      - name: Update leaderboard
        run: |
          cd engine
          node -e "
            const fs = require('fs');
            const { loadState } = require('./dist/loader.js');
            const { generateLeaderboardMarkdown } = require('./dist/leaderboard.js');
            
            const state = loadState();
            const leaderboard = generateLeaderboardMarkdown(state);
            
            let readme = fs.readFileSync('../README.md', 'utf8');
            
            const startMarker = '## ðŸ† Leaderboards';
            if (readme.includes(startMarker)) {
              const start = readme.indexOf(startMarker);
              const afterStart = readme.substring(start);
              const endMatch = afterStart.match(/\\n---\\n/);
              if (endMatch) {
                const end = start + endMatch.index + endMatch[0].length;
                readme = readme.substring(0, start) + leaderboard + '\\n---\\n' + readme.substring(end);
                fs.writeFileSync('../README.md', readme);
                console.log('Leaderboard updated');
              }
            }
          "
      
      - name: Archive & Scale Check
        run: |
          node -e "
            const fs = require('fs');
            const state = JSON.parse(fs.readFileSync('state.json', 'utf8'));
            
            const LIMITS = {
              maxStateKB: 500,           // Archive when state.json > 500KB
              maxKarmaLogEntries: 1000,  // Keep last 1000 karma events
              maxInactiveDays: 60,       // Archive players inactive > 60 days
              archiveDir: 'archives'
            };
            
            const stateSize = Buffer.byteLength(JSON.stringify(state)) / 1024;
            console.log('ðŸ“Š State size:', stateSize.toFixed(1), 'KB');
            console.log('ðŸ‘¥ Total players:', Object.keys(state.players || {}).length);
            
            let archived = { players: 0, karmaLogs: 0 };
            const now = new Date();
            
            // 1. Prune old karma_log entries
            if (state.engagement?.karma_log?.length > LIMITS.maxKarmaLogEntries) {
              const overflow = state.engagement.karma_log.length - LIMITS.maxKarmaLogEntries;
              const toArchive = state.engagement.karma_log.splice(0, overflow);
              archived.karmaLogs = toArchive.length;
              
              // Save to archive
              fs.mkdirSync(LIMITS.archiveDir, { recursive: true });
              const archiveFile = LIMITS.archiveDir + '/karma_log_' + now.toISOString().split('T')[0] + '.json';
              const existing = fs.existsSync(archiveFile) ? JSON.parse(fs.readFileSync(archiveFile)) : [];
              fs.writeFileSync(archiveFile, JSON.stringify([...existing, ...toArchive], null, 2));
            }
            
            // 2. Archive inactive players (keep their data, just move out of active state)
            if (state.players) {
              const inactivePlayers = {};
              for (const [name, data] of Object.entries(state.players)) {
                const lastActive = new Date(data.last_pr_at || data.joined || '2020-01-01');
                const daysSinceActive = (now - lastActive) / (1000 * 60 * 60 * 24);
                
                if (daysSinceActive > LIMITS.maxInactiveDays && Object.keys(state.players).length > 100) {
                  inactivePlayers[name] = { ...data, archived_at: now.toISOString() };
                  delete state.players[name];
                  archived.players++;
                }
              }
              
              // Save archived players
              if (Object.keys(inactivePlayers).length > 0) {
                fs.mkdirSync(LIMITS.archiveDir, { recursive: true });
                const archiveFile = LIMITS.archiveDir + '/inactive_players.json';
                const existing = fs.existsSync(archiveFile) ? JSON.parse(fs.readFileSync(archiveFile)) : {};
                fs.writeFileSync(archiveFile, JSON.stringify({ ...existing, ...inactivePlayers }, null, 2));
              }
            }
            
            // 3. Save cleaned state
            fs.writeFileSync('state.json', JSON.stringify(state, null, 2));
            
            console.log('ðŸ—ƒï¸  Archived karma logs:', archived.karmaLogs);
            console.log('ðŸ—ƒï¸  Archived inactive players:', archived.players);
            console.log('âœ… Scale check complete');
          "
      
      - name: Configure git
        run: |
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
      
      - name: Commit changes
        run: |
          git add state.json README.md archives/ backups/ 2>/dev/null || true
          if ! git commit -m "ðŸ”§ Daily maintenance - $(date +%Y-%m-%d) [skip ci]"; then
            echo "::notice::No changes to commit"
          elif ! git push; then
            echo "::warning::Push failed - may require manual sync or retry"
            exit 1
          fi
