# ðŸ’œ GUARDIAN ANGEL SYSTEM
# Nessuno viene lasciato indietro. Mai.
# Se un player Ã¨ inattivo, il sistema lo chiama con amore.

name: ðŸ’œ Guardian Angel

on:
  schedule:
    - cron: '0 9 * * *'  # Every day at 9:00 UTC
  workflow_dispatch:

jobs:
  check-inactive-players:
    runs-on: [self-hosted, enjoy-trusted]
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ’œ Check on Everyone
        run: |
          STATE=$(cat state.json)
          NOW=$(date +%s)
          
          mkdir -p guardian/hearts
          
          echo "## ðŸ’œ Guardian Angel Report" > guardian/daily-report.md
          echo "" >> guardian/daily-report.md
          echo "**Date:** $(date -u +%Y-%m-%d)" >> guardian/daily-report.md
          echo "" >> guardian/daily-report.md
          
          # Check each player
          echo "$STATE" | jq -r '.players | to_entries[] | "\(.key)|\(.value.last_contribution // .value.joined)|\(.value.karma)|\(.value.streak)"' | while IFS='|' read -r PLAYER LAST_ACTIVE KARMA STREAK; do
            
            # Calculate days since last activity
            if [ -n "$LAST_ACTIVE" ]; then
              LAST_EPOCH=$(date -d "$LAST_ACTIVE" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_ACTIVE" +%s 2>/dev/null || echo $NOW)
              DAYS_INACTIVE=$(( (NOW - LAST_EPOCH) / 86400 ))
            else
              DAYS_INACTIVE=0
            fi
            
            echo "Checking $PLAYER: $DAYS_INACTIVE days inactive, $KARMA karma, $STREAK streak"
            
            # Generate appropriate response based on inactivity
            if [ $DAYS_INACTIVE -ge 30 ]; then
              # 30+ days: Generate "We Miss You" heart
              STATUS="ðŸ’” Missed (30+ days)"
              HEART_MSG="We miss you, $PLAYER! Your karma ($KARMA) is waiting for you. The void remembers."
              HEART_COLOR="#ff6b6b"
              
            elif [ $DAYS_INACTIVE -ge 14 ]; then
              # 14-29 days: Generate "Thinking of You" heart  
              STATUS="ðŸ’› Thinking of you (14+ days)"
              HEART_MSG="Hey $PLAYER! Just checking in. Your $KARMA karma misses growing. Come play?"
              HEART_COLOR="#ffd93d"
              
            elif [ $DAYS_INACTIVE -ge 7 ]; then
              # 7-13 days: Generate "See You Soon" heart
              STATUS="ðŸ’š See you soon (7+ days)"
              HEART_MSG="$PLAYER, your streak of $STREAK is waiting! Ready for more karma?"
              HEART_COLOR="#22c55e"
              
            else
              # Active player: Generate "Love" heart
              STATUS="ðŸ’œ Active & Loved"
              HEART_MSG="$PLAYER is thriving! $KARMA karma, $STREAK streak. Keep shining!"
              HEART_COLOR="#a855f7"
            fi
            
            echo "- **$PLAYER**: $STATUS" >> guardian/daily-report.md
            
            # Generate personalized SVG heart for inactive players
            if [ $DAYS_INACTIVE -ge 7 ]; then
              cat > guardian/hearts/heart-${PLAYER}.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 180" width="200" height="180">
            <defs>
              <filter id="heartGlow">
                <feGaussianBlur stdDeviation="3" result="blur"/>
                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
              </filter>
            </defs>
            <rect width="200" height="180" fill="#0d1117" rx="10"/>
            
            <!-- Animated heart -->
            <g transform="translate(100, 70)" filter="url(#heartGlow)">
              <path d="M0,30 C-10,20 -30,0 -30,-15 C-30,-35 -10,-40 0,-25 C10,-40 30,-35 30,-15 C30,0 10,20 0,30Z" 
                    fill="${HEART_COLOR}">
                <animate attributeName="d" dur="1s" repeatCount="indefinite"
                  values="M0,30 C-10,20 -30,0 -30,-15 C-30,-35 -10,-40 0,-25 C10,-40 30,-35 30,-15 C30,0 10,20 0,30Z;
                          M0,28 C-8,18 -28,2 -28,-13 C-28,-33 -8,-38 0,-23 C8,-38 28,-33 28,-13 C28,2 8,18 0,28Z;
                          M0,30 C-10,20 -30,0 -30,-15 C-30,-35 -10,-40 0,-25 C10,-40 30,-35 30,-15 C30,0 10,20 0,30Z"/>
              </path>
            </g>
            
            <!-- Message -->
            <text x="100" y="130" text-anchor="middle" font-family="Arial" font-size="10" fill="#fff">
              ${HEART_MSG}
            </text>
            <text x="100" y="150" text-anchor="middle" font-family="Arial" font-size="8" fill="#8b949e">
              ðŸ’œ from the enjoy community
            </text>
            <text x="100" y="170" text-anchor="middle" font-family="monospace" font-size="6" fill="#4a5568">
              karma:${KARMA} | days away:${DAYS_INACTIVE}
            </text>
          </svg>
          SVGEOF
              
              echo "  - Generated heart for $PLAYER" >> guardian/daily-report.md
            fi
            
          done
          
          echo "" >> guardian/daily-report.md
          echo "---" >> guardian/daily-report.md
          echo "*Generated with infinite love by Guardian Angel ðŸ’œ*" >> guardian/daily-report.md
          
      - name: ðŸ“Š Generate Community Health
        run: |
          STATE=$(cat state.json)
          
          TOTAL_PLAYERS=$(echo "$STATE" | jq '.meta.total_players')
          TOTAL_KARMA=$(echo "$STATE" | jq '.score.total')
          
          # Calculate love metrics
          if [ "$TOTAL_PLAYERS" -gt 0 ]; then
            AVG_KARMA=$(( TOTAL_KARMA / TOTAL_PLAYERS ))
          else
            AVG_KARMA=0
          fi
          
          # Community mood based on activity
          ACTIVE_HEARTS=$(ls -1 guardian/hearts/*.svg 2>/dev/null | wc -l)
          
          if [ "$ACTIVE_HEARTS" -eq 0 ]; then
            MOOD="ðŸŒŸ Thriving! Everyone is active!"
            MOOD_COLOR="#22c55e"
          elif [ "$ACTIVE_HEARTS" -lt 3 ]; then
            MOOD="ðŸ’š Healthy! A few friends need hugs."
            MOOD_COLOR="#84cc16"
          elif [ "$ACTIVE_HEARTS" -lt 5 ]; then
            MOOD="ðŸ’› Reaching out to friends..."
            MOOD_COLOR="#ffd93d"
          else
            MOOD="ðŸ’œ Sending lots of love to everyone!"
            MOOD_COLOR="#a855f7"
          fi
          
          # Generate community love SVG
          cat > guardian/community-love.svg << SVGEOF
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 100" width="400" height="100">
            <rect width="400" height="100" fill="#0d1117" rx="10"/>
            <text x="200" y="35" text-anchor="middle" font-family="Arial Black" font-size="20" fill="${MOOD_COLOR}">ðŸ’œ COMMUNITY LOVE INDEX ðŸ’œ</text>
            <text x="200" y="60" text-anchor="middle" font-family="Arial" font-size="14" fill="#fff">${MOOD}</text>
            <text x="200" y="85" text-anchor="middle" font-family="monospace" font-size="10" fill="#8b949e">
              ${TOTAL_PLAYERS} souls | ${TOTAL_KARMA} karma | ${AVG_KARMA} avg | ${ACTIVE_HEARTS} need ðŸ’œ
            </text>
          </svg>
          SVGEOF
          
      - name: ðŸ’¾ Commit Guardian Report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add guardian/
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit"
          else
            git commit -m "ðŸ’œ Guardian Angel daily check - spreading love [skip ci]"
            if ! git push; then
              echo "::warning::Push failed - may require manual sync or retry"
              exit 1
            fi
          fi
          
      - name: ðŸ“¢ Summary
        run: |
          echo "## ðŸ’œ Guardian Angel Complete" >> $GITHUB_STEP_SUMMARY
          cat guardian/daily-report.md >> $GITHUB_STEP_SUMMARY
