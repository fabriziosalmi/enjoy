# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŒ TRANSLATION KARMA - Reward contributors for translations
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Translations break language barriers and spread the game worldwide.
# Every translation is a gift to humanity - reward it generously!
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸŒ Translation Karma

on:
  pull_request:
    types: [closed]
    paths:
      - 'README.*.md'
      - 'QUICKSTART.*.md'
      - 'CONTRIBUTING.*.md'
      - 'MANIFESTO.*.md'
      - 'PLAY.*.md'
      - 'i18n/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

jobs:
  award-translation-karma:
    if: github.event.pull_request.merged == true
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECURITY NOTE: Using self-hosted + PAT because we need to push to main
    # This is safe because it only runs AFTER merge, not on untrusted PR code
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    runs-on: [self-hosted, enjoy-trusted]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PAT }}
      
      - name: ğŸ” Analyze Translation
        id: analyze
        env:
          AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # Get changed files
          CHANGED_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path')
          echo "Changed files: $CHANGED_FILES"
          
          # Count translation files
          TRANSLATION_COUNT=0
          NEW_LANGUAGE=false
          LANGUAGES=""
          
          for file in $CHANGED_FILES; do
            # Match README.xx.md pattern
            if [[ $file =~ ^README\.([a-z]{2})\.md$ ]]; then
              LANG="${BASH_REMATCH[1]}"
              LANGUAGES="$LANGUAGES $LANG"
              TRANSLATION_COUNT=$((TRANSLATION_COUNT + 1))
              
              # Check if this is a new translation
              if git show HEAD~1:$file 2>/dev/null | head -1 > /dev/null 2>&1; then
                echo "Update to existing: $file"
              else
                echo "NEW translation: $file"
                NEW_LANGUAGE=true
              fi
            fi
            
            # Match other translatable files
            if [[ $file =~ \.(es|fr|de|pt|ja|zh|ko|ru|ar|hi|it|pl|vi|id|th|tr|nl|sv|da|no|fi|cs|el|he|uk|ro|hu|bg|hr|sk|sl|et|lv|lt|ms|tl|bn|ta|te|mr|gu|kn|ml|pa|ne|si|my|km|lo)\.md$ ]]; then
              LANG="${BASH_REMATCH[1]}"
              TRANSLATION_COUNT=$((TRANSLATION_COUNT + 1))
            fi
          done
          
          echo "translation_count=$TRANSLATION_COUNT" >> $GITHUB_OUTPUT
          echo "new_language=$NEW_LANGUAGE" >> $GITHUB_OUTPUT
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          
          # Calculate karma (aligned with bounties.md)
          # New language = +100 (as per Translator bounty)
          # Update = +50
          # Additional files = +15 each
          
          if [ "$NEW_LANGUAGE" = "true" ]; then
            BASE_KARMA=100
          else
            BASE_KARMA=50
          fi
          
          # Additional files bonus (QUICKSTART, CONTRIBUTING, etc.)
          EXTRA_FILES=$((TRANSLATION_COUNT - 1))
          if [ $EXTRA_FILES -gt 0 ]; then
            FILE_BONUS=$((EXTRA_FILES * 15))
          else
            FILE_BONUS=0
          fi
          
          TOTAL_KARMA=$((BASE_KARMA + FILE_BONUS))
          
          echo "base_karma=$BASE_KARMA" >> $GITHUB_OUTPUT
          echo "file_bonus=$FILE_BONUS" >> $GITHUB_OUTPUT
          echo "total_karma=$TOTAL_KARMA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT }}
      
      - name: ğŸ’« Award Translation Karma
        if: steps.analyze.outputs.translation_count > 0
        run: |
          AUTHOR="${{ steps.analyze.outputs.author }}"
          KARMA="${{ steps.analyze.outputs.total_karma }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          PR_NUMBER="${{ steps.analyze.outputs.pr_number }}"

          # Update state.json (consistent with rest of game)
          if [ -f "state.json" ]; then
            STATE=$(cat state.json)

            # Initialize player if new
            if [ "$(echo "$STATE" | jq -r ".players.\"$AUTHOR\" // \"null\"")" = "null" ]; then
              STATE=$(echo "$STATE" | jq \
                --arg author "$AUTHOR" \
                --arg time "$TIMESTAMP" \
                '.players[$author] = {karma: 0, prs: 0, streak: 0, achievements: [], joined: $time}')
              STATE=$(echo "$STATE" | jq '.meta.total_players += 1')
              echo "ğŸ†• New player: $AUTHOR"
            fi

            # Add karma to player
            STATE=$(echo "$STATE" | jq \
              --arg author "$AUTHOR" \
              --argjson karma "$KARMA" \
              --arg time "$TIMESTAMP" \
              '.players[$author].karma += $karma |
               .players[$author].prs += 1 |
               .players[$author].last_contribution = $time |
               .players[$author].translations = ((.players[$author].translations // 0) + 1)')

            # Add translation achievement if first translation
            TRANS_COUNT=$(echo "$STATE" | jq -r ".players.\"$AUTHOR\".translations // 0")
            if [ "$TRANS_COUNT" = "1" ]; then
              STATE=$(echo "$STATE" | jq \
                --arg author "$AUTHOR" \
                '.players[$author].achievements += ["translator"]')
              echo "ğŸ† Achievement unlocked: translator"
            fi

            # Update global state
            STATE=$(echo "$STATE" | jq \
              --argjson karma "$KARMA" \
              --arg time "$TIMESTAMP" \
              --arg pr "#$PR_NUMBER" \
              '.score.total += $karma |
               .score.today += $karma |
               .meta.total_prs += 1 |
               .last_updated = $time |
               .last_pr = $pr')

            echo "$STATE" | jq '.' > state.json
          fi

          # Commit
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
          git add state.json
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit"
          else
            git commit -m "ğŸŒ +$KARMA karma to @$AUTHOR for translation [skip ci]"
            # Retry push up to 3 times
            for i in 1 2 3; do
              if git push; then
                echo "âœ… Push successful"
                break
              else
                echo "âš ï¸ Push attempt $i failed, retrying..."
                git pull --rebase origin main
                sleep 2
              fi
            done
          fi
      
      - name: ğŸ‰ Celebration Comment
        if: steps.analyze.outputs.translation_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const author = '${{ steps.analyze.outputs.author }}';
            const totalKarma = '${{ steps.analyze.outputs.total_karma }}';
            const baseKarma = '${{ steps.analyze.outputs.base_karma }}';
            const fileBonus = '${{ steps.analyze.outputs.file_bonus }}';
            const languages = '${{ steps.analyze.outputs.languages }}'.trim();
            const isNew = '${{ steps.analyze.outputs.new_language }}' === 'true';
            const count = '${{ steps.analyze.outputs.translation_count }}';
            
            const langFlags = {
              'es': 'ğŸ‡ªğŸ‡¸', 'fr': 'ğŸ‡«ğŸ‡·', 'de': 'ğŸ‡©ğŸ‡ª', 'pt': 'ğŸ‡µğŸ‡¹', 'ja': 'ğŸ‡¯ğŸ‡µ',
              'zh': 'ğŸ‡¨ğŸ‡³', 'ko': 'ğŸ‡°ğŸ‡·', 'ru': 'ğŸ‡·ğŸ‡º', 'ar': 'ğŸ‡¸ğŸ‡¦', 'hi': 'ğŸ‡®ğŸ‡³',
              'it': 'ğŸ‡®ğŸ‡¹', 'pl': 'ğŸ‡µğŸ‡±', 'vi': 'ğŸ‡»ğŸ‡³', 'id': 'ğŸ‡®ğŸ‡©', 'th': 'ğŸ‡¹ğŸ‡­',
              'tr': 'ğŸ‡¹ğŸ‡·', 'nl': 'ğŸ‡³ğŸ‡±', 'sv': 'ğŸ‡¸ğŸ‡ª', 'da': 'ğŸ‡©ğŸ‡°', 'no': 'ğŸ‡³ğŸ‡´',
              'fi': 'ğŸ‡«ğŸ‡®', 'cs': 'ğŸ‡¨ğŸ‡¿', 'el': 'ğŸ‡¬ğŸ‡·', 'he': 'ğŸ‡®ğŸ‡±', 'uk': 'ğŸ‡ºğŸ‡¦',
              'ro': 'ğŸ‡·ğŸ‡´', 'hu': 'ğŸ‡­ğŸ‡º', 'bg': 'ğŸ‡§ğŸ‡¬', 'hr': 'ğŸ‡­ğŸ‡·', 'sk': 'ğŸ‡¸ğŸ‡°'
            };
            
            const flags = languages.split(' ').map(l => langFlags[l] || 'ğŸŒ').join(' ');
            
            let message = `## ğŸŒ Translation Merged! ${flags}\n\n`;
            message += `Thank you @${author} for bringing enjoy to new audiences!\n\n`;
            
            message += `### ğŸ’« Karma Breakdown\n\n`;
            message += `| Type | Amount |\n`;
            message += `|------|--------|\n`;
            
            if (isNew) {
              message += `| ğŸ†• **New language** (Translator bounty!) | +${baseKarma} |\n`;
            } else {
              message += `| Translation update | +${baseKarma} |\n`;
            }
            
            if (parseInt(fileBonus) > 0) {
              message += `| Additional files | +${fileBonus} |\n`;
            }
            
            message += `| **Total** | **+${totalKarma}** |\n\n`;
            
            if (isNew) {
              message += `### ğŸ–ï¸ Achievement Unlocked!\n\n`;
              message += `**ğŸŒ Language Pioneer** - First translation for a new language!\n\n`;
            }
            
            message += `---\n\n`;
            message += `*"One language sets you in a corridor for life. Two languages open every door along the way."*\n\n`;
            message += `You've opened doors for millions. Thank you! ğŸ’œ\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
      
      - name: ğŸ·ï¸ Add Translator Label
        if: steps.analyze.outputs.new_language == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const author = '${{ steps.analyze.outputs.author }}';
            
            // Add label to PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['ğŸŒ translation', 'ğŸ†• new-language']
            });
